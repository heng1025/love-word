// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import * as TranslateResult from "../components/TranslateResult.js";

var common = chrome.runtime.getURL("assets/common.css");

function ContentApp(Props) {
  var containerEl = React.useRef(null);
  var match = React.useState(function () {
        return "0";
      });
  var setTop = match[1];
  var match$1 = React.useState(function () {
        return "0";
      });
  var setLeft = match$1[1];
  var match$2 = React.useState(function () {
        return "0";
      });
  var setOpactity = match$2[1];
  var opacity = match$2[0];
  var match$3 = React.useState(function () {
        return /* Noop */2;
      });
  var setLoading = match$3[1];
  var loading = match$3[0];
  var match$4 = React.useState(function () {
        return "";
      });
  var seErrText = match$4[1];
  var match$5 = React.useState(function () {
        return [];
      });
  var setResults = match$5[1];
  var match$6 = React.useState(function () {
        return false;
      });
  var setMouseClick = match$6[1];
  var isMouseClick = match$6[0];
  var updatePos = function (ev) {
    var x = ev.pageX - 50 | 0;
    var y = ev.pageY + 30 | 0;
    setTop(function (_p) {
          return "" + y.toString() + "px";
        });
    setLeft(function (_p) {
          return "" + x.toString() + "px";
        });
  };
  var showTransPanel = function (target) {
    var text = window.getSelection().toString().trim();
    if (text !== "" && loading === /* Noop */2 && !containerEl.current.contains(target)) {
      setLoading(function (param) {
            return /* Yes */0;
          });
      seErrText(function (param) {
            return "";
          });
      chrome.runtime.sendMessage(text).then(function (ret) {
            if (ret.TAG === /* Ok */0) {
              var trans_result = ret._0;
              setResults(function (_p) {
                    return trans_result;
                  });
            } else {
              var msg = ret._0;
              seErrText(function (_p) {
                    return msg;
                  });
            }
            setLoading(function (_p) {
                  return /* No */1;
                });
          });
      return setOpactity(function (_p) {
                  return "1";
                });
    }
    
  };
  React.useEffect((function () {
          var firtTime = {
            contents: 0
          };
          var lastTime = {
            contents: 0
          };
          var handleMouseDown = function (e) {
            e.stopPropagation();
            firtTime.contents = Date.now();
          };
          var handleMouseUp = function (ev) {
            ev.stopPropagation();
            lastTime.contents = Date.now();
            var delta = lastTime.contents - firtTime.contents | 0;
            var clickState = delta < 250;
            setMouseClick(function (_p) {
                  return clickState;
                });
            if (!clickState && ev.altKey) {
              updatePos(ev);
              return showTransPanel(ev.target);
            }
            
          };
          var handleDblclick = function (ev) {
            if (ev.altKey) {
              updatePos(ev);
              return showTransPanel(ev.target);
            }
            
          };
          var handleKeyup = function (ev) {
            if (ev.keyCode === 18) {
              return showTransPanel(ev.target);
            }
            
          };
          window.addEventListener("mousedown", handleMouseDown);
          window.addEventListener("dblclick", handleDblclick);
          window.addEventListener("mouseup", handleMouseUp);
          window.addEventListener("keyup", handleKeyup);
          return (function (param) {
                    window.removeEventListener("mousedown", handleMouseDown);
                    window.removeEventListener("dblclick", handleDblclick);
                    window.removeEventListener("mouseup", handleMouseUp);
                    window.removeEventListener("keyup", handleKeyup);
                  });
        }), []);
  React.useEffect((function () {
          var handleClick = function (e) {
            e.stopPropagation();
            if (isMouseClick && opacity === "1" && !containerEl.current.contains(e.target)) {
              setOpactity(function (_p) {
                    return "0";
                  });
              setResults(function (_p) {
                    return [];
                  });
              return setMouseClick(function (_p) {
                          return false;
                        });
            }
            
          };
          window.addEventListener("click", handleClick);
          return (function (param) {
                    window.removeEventListener("click", handleClick);
                  });
        }), [
        isMouseClick,
        opacity
      ]);
  var style = {
    left: match$1[0],
    top: match[0],
    opacity: opacity
  };
  return React.createElement("div", {
              ref: containerEl,
              className: "absolute z-[99999]",
              style: style
            }, React.createElement("link", {
                  href: common,
                  rel: "stylesheet"
                }), React.createElement("div", {
                  className: "card w-52 bg-primary text-primary-content"
                }, React.createElement("div", {
                      className: "card-body p-4"
                    }, React.createElement("h4", {
                          className: "card-title text-sm"
                        }, "译文："), React.createElement(TranslateResult.make, {
                          loading: loading,
                          errText: match$4[0],
                          results: match$5[0],
                          className: "text-sm min-h-6"
                        }))));
}

var make = ContentApp;

export {
  common ,
  make ,
}
/* common Not a pure module */
